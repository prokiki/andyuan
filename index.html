<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827"/>
<title>家庭激励系统 · 简易版（PWA）</title>
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f7f7f8; color:#222;}
  header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; z-index:10;}
  header h1{margin:0; font-size:18px;}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .tab{padding:8px 12px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; font-size:14px;}
  .tab.active{background:#111; color:#fff; border-color:#111;}
  main{padding:16px; max-width:1100px; margin:0 auto;}
  section{display:none;}
  section.active{display:block;}
  h2{font-size:18px; margin:12px 0;}
  .grid{display:grid; gap:12px;}
  .grid.cols-2{grid-template-columns:1fr 1fr;}
  .card{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;}
  table{width:100%; border-collapse:collapse; font-size:14px;}
  th,td{border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top;}
  tr:last-child td{border-bottom:none;}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; font-size:14px;
  }
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .btn{padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#111; color:#fff; cursor:pointer; font-size:14px;}
  .btn.secondary{background:#fff; color:#111;}
  .muted{color:#6b7280; font-size:12px;}
  .kpi{display:flex; gap:16px; flex-wrap:wrap;}
  .kpi .item{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:140px;}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px;}
  .danger{color:#b91c1c}
  .success{color:#065f46}
  .nowrap{white-space:nowrap}
  .right{text-align:right}
  .mb8{margin-bottom:8px}
  .mb12{margin-bottom:12px}
  .mb16{margin-bottom:16px}
  .mt8{margin-top:8px}
  .mt16{margin-top:16px}
</style>
</head>
<body>
<header>
  <h1>家庭激励系统 · 简易版（PWA）</h1>
  <div class="tabs" id="tabs"></div>
</header>
<main>
  <!-- 今日任务 -->
  <section id="tab-today" class="active">
    <div class="grid cols-2">
      <div class="card">
        <h2>今日任务清单</h2>
        <div class="row mb8">
          <input id="newTaskName" placeholder="新增任务名称（如：按时完成语文作业）"/>
          <input id="newTaskPoints" type="number" placeholder="积分" min="1" style="max-width:120px"/>
          <select id="newTaskType" style="max-width:140px">
            <option value="基础任务">基础任务</option>
            <option value="成长任务">成长任务</option>
            <option value="自选任务">自选任务</option>
          </select>
          <button class="btn" id="addTaskBtn">新增任务</button>
        </div>
        <table id="taskTable">
          <thead><tr><th>完成</th><th>任务</th><th>类型</th><th>积分</th><th>备注</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row mt16">
          <button class="btn" id="saveTodayBtn">保存今日完成情况</button>
          <span class="muted" id="todayInfo"></span>
        </div>
      </div>
      <div class="card">
        <h2>今日积分</h2>
        <div class="kpi">
          <div class="item"><div class="muted">今日日期</div><div id="todayDate"></div></div>
          <div class="item"><div class="muted">今日总分</div><div id="todayTotal" style="font-weight:600"></div></div>
          <div class="item"><div class="muted">本周累计</div><div id="weekTotal" style="font-weight:600"></div></div>
        </div>
        <h3 class="mt16">今日完成记录</h3>
        <table id="todayLog"><thead><tr><th>任务</th><th>类型</th><th>积分</th><th>完成</th><th>备注</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 积分与兑换（兑换生成时间券入库） -->
  <section id="tab-reward">
    <div class="grid cols-2">
      <div class="card">
        <h2>奖励菜单</h2>
        <div class="row mb8">
          <input id="rewardName" placeholder="奖励名称（如：玩30分钟游戏）"/>
          <input id="rewardCost" type="number" placeholder="所需积分" min="1" style="max-width:140px"/>
          <select id="rewardType" style="max-width:140px">
            <option value="数字类">数字类</option>
            <option value="情感类">情感类</option>
            <option value="体验类">体验类</option>
            <option value="自由类">自由类</option>
          </select>
          <button class="btn" id="addRewardBtn">新增奖励</button>
        </div>
        <table id="rewardTable"><thead><tr><th>类别</th><th>奖励</th><th>所需积分</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>积分兑换 → 生成时间券</h2>
        <div class="kpi">
          <div class="item"><div class="muted">可用积分</div><div id="availablePoints" style="font-weight:600"></div></div>
          <div class="item"><div class="muted">本周兑换次数</div><div id="redeemCount" style="font-weight:600"></div></div>
        </div>
        <div class="row mt16">
          <select id="rewardSelect" style="min-width:240px"></select>
          <button class="btn" id="redeemBtn">兑换为时间券</button>
          <span class="muted">规则：完成所有基础任务后可兑换；每周次数上限可在设置中调整。</span>
        </div>
        <h3 class="mt16">兑换记录</h3>
        <table id="redeemLog"><thead><tr><th>时间</th><th>奖励</th><th>消耗</th><th>备注</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 时间券库存与使用 -->
  <section id="tab-coupons">
    <div class="grid cols-2">
      <div class="card">
        <h2>时间券库存</h2>
        <table id="couponTable"><thead><tr><th>券名</th><th>库存</th><th></th></tr></thead><tbody></tbody></table>
        <div class="row mt16">
          <input id="newCouponName" placeholder="自定义时间券名称（可选）"/>
          <button class="btn secondary" id="addCouponType">新增券种</button>
        </div>
      </div>
      <div class="card">
        <h2>使用时间券</h2>
        <div class="kpi">
          <div class="item"><div class="muted">今日已用券数</div><div id="todayCouponUsed" style="font-weight:600"></div></div>
          <div class="item"><div class="muted">每日使用上限</div><div id="dailyCouponLimit" style="font-weight:600"></div></div>
        </div>
        <div class="row mt16">
          <select id="couponSelect" style="min-width:240px"></select>
          <button class="btn" id="useCouponBtn">使用</button>
          <span class="muted">默认每天最多使用 1 张，可在设置调整。</span>
        </div>
        <h3 class="mt16">使用记录</h3>
        <table id="couponLog"><thead><tr><th>时间</th><th>券名</th><th>备注</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 成长等级 -->
  <section id="tab-levels">
    <div class="card">
      <h2>成长等级</h2>
      <p class="muted">根据周均分与连续达成情况自动评估。</p>
      <table id="levelTable">
        <thead><tr><th>等级</th><th>条件</th><th>特权</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mt16">
        <span class="pill" id="currentLevel">当前等级：计算中…</span>
      </div>
    </div>
  </section>

  <!-- 每周总结 -->
  <section id="tab-review">
    <div class="card">
      <h2>每周总结卡</h2>
      <div class="grid">
        <label>我本周最满意的一件事是：<textarea id="r1" rows="2"></textarea></label>
        <label>我遇到的一个困难是：<textarea id="r2" rows="2"></textarea></label>
        <label>我解决它的方式是：<textarea id="r3" rows="2"></textarea></label>
        <label>我下周想挑战的目标是：<textarea id="r4" rows="2"></textarea></label>
        <label>我希望家长给予的支持是：<textarea id="r5" rows="2"></textarea></label>
      </div>
      <div class="row mt16">
        <button class="btn" id="saveReviewBtn">保存本周总结</button>
        <button class="btn secondary" id="exportReviewBtn">导出全部总结（JSON）</button>
        <span class="muted" id="reviewInfo"></span>
      </div>
      <h3 class="mt16">历史总结</h3>
      <table id="reviewTable"><thead><tr><th>周起始日</th><th>摘要</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- 设置/导入导出 -->
  <section id="tab-settings">
    <div class="grid cols-2">
      <div class="card">
        <h2>系统设置</h2>
        <div class="grid">
          <label>每周兑换次数上限：<input id="maxWeeklyRedeem" type="number" min="1" value="2"/></label>
          <label>每日积分上限（防刷分）：<input id="maxDailyPoints" type="number" min="1" value="30"/></label>
          <label>每日使用时间券上限：<input id="maxDailyCoupons" type="number" min="1" value="1"/></label>
        </div>
        <div class="row mt16">
          <button class="btn" id="saveSettingsBtn">保存设置</button>
          <span class="muted" id="settingsInfo"></span>
        </div>
        <p class="muted mt8">提示：PWA 需通过 HTTPS 或本地服务器访问，才能安装并离线缓存。</p>
      </div>
      <div class="card">
        <h2>数据管理（离线）</h2>
        <div class="row">
          <button class="btn" id="exportBtn">导出数据（JSON）</button>
          <input type="file" id="importFile" accept="application/json"/>
          <button class="btn secondary" id="importBtn">导入</button>
          <button class="btn secondary danger" id="resetBtn">清空所有数据</button>
        </div>
        <p class="muted mt8">所有数据保存在浏览器本地（localStorage），可手动导出/导入备份。</p>
      </div>
    </div>
  </section>
</main>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const todayStr = () => new Date().toISOString().slice(0,10);
const weekStartStr = (d=new Date())=>{
  const date = new Date(d);
  const day = date.getDay(); // 0 Sun - 6 Sat
  const diff = (day===0? -6 : 1) - day; // Monday start
  date.setDate(date.getDate()+diff);
  return date.toISOString().slice(0,10);
};

// ------- State --------
const defaultState = {
  settings:{ maxWeeklyRedeem:2, maxDailyPoints:30, maxDailyCoupons:1 },
  tasks:[
    {id:1,name:"按时完成语文作业",points:5,type:"基础任务"},
    {id:2,name:"按时完成数学作业",points:5,type:"基础任务"},
    {id:3,name:"认真检查、无错别字",points:3,type:"成长任务"},
    {id:4,name:"主动预习明天课程",points:5,type:"成长任务"},
    {id:5,name:"主动整理书包/文具",points:2,type:"基础任务"},
    {id:6,name:"阅读课外书 20 分钟",points:3,type:"成长任务"},
    {id:7,name:"提前完成所有作业",points:5,type:"成长任务"}
  ],
  rewards:[
    {id:1,type:"数字类",name:"15 分钟游戏券",cost:10, coupon:true},
    {id:2,type:"数字类",name:"30 分钟游戏券",cost:20, coupon:true},
    {id:3,type:"数字类",name:"45 分钟游戏券（周末）",cost:30, coupon:true},
    {id:4,type:"体验类",name:"选择周末活动或晚餐",cost:40, coupon:false},
    {id:5,type:"自由类",name:"自己安排 1 小时活动",cost:50, coupon:false},
    {id:6,type:"情感类",name:"睡前多讲一个故事",cost:10, coupon:false}
  ],
  // records[date] = { items: {taskId: {done:bool, note:""}}, total }
  records:{},
  // redeem logs
  redeem:[], // {ts, weekStart, name, cost}
  // coupons inventory counts by name
  coupons:{ // e.g., "15 分钟游戏券": {count: 0, usedLogs: [{ts}]}
  },
  // coupons usage logs {ts,name}
  couponLogs:[],
  // weekly reviews
  reviews:{},
  // growth levels static
  levels:[
    {level:"LV.1 初学者", cond:"周均分≥80", perk:"可兑换15分钟游戏券"},
    {level:"LV.2 能干者", cond:"连续两周周均分≥85", perk:"1次自由安排1小时"},
    {level:"LV.3 小达人", cond:"连续4周无缺交 + 总分≥350", perk:"可自定一个额外奖励"}
  ]
};

function loadState(){
  try{
    const raw = localStorage.getItem("family_reward_state_pwa_v1");
    if(!raw){ saveState(defaultState); return JSON.parse(JSON.stringify(defaultState)); }
    return JSON.parse(raw);
  }catch(e){ console.error(e); return JSON.parse(JSON.stringify(defaultState)); }
}
function saveState(s){ localStorage.setItem("family_reward_state_pwa_v1", JSON.stringify(s)); }
let state = loadState();

// ------- Tabs --------
const tabDefs = [
  {id:"today", name:"今日任务"},
  {id:"reward", name:"积分与兑换"},
  {id:"coupons", name:"时间券"},
  {id:"levels", name:"成长等级"},
  {id:"review", name:"每周总结"},
  {id:"settings", name:"设置/导入导出"}
];
function renderTabs(){
  const tabsEl = document.getElementById("tabs");
  tabsEl.innerHTML = "";
  tabDefs.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (t.id==="today"?" active":"");
    b.textContent = t.name;
    b.onclick = ()=>{
      $$(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $$("main section").forEach(sec=>sec.classList.remove("active"));
      document.getElementById("tab-"+t.id).classList.add("active");
      if(t.id==="levels") computeLevel();
      if(t.id==="coupons") renderCoupons();
    };
    tabsEl.appendChild(b);
  });
}

// ------- Helpers -------
function ensureRecord(date){
  if(!state.records[date]) state.records[date] = {items:{}, total:0};
}
function dayKey(d){ return new Date(d).toISOString().slice(0,10); }

// ------- Today tasks --------
function renderTaskTable(){
  const tb = $("#taskTable tbody");
  tb.innerHTML = "";
  const date = todayStr();
  ensureRecord(date);
  state.tasks.forEach(task=>{
    const tr = document.createElement("tr");
    const rec = state.records[date].items[task.id] || {done:false, note:""};
    tr.innerHTML = `
      <td><input type="checkbox" ${rec.done?"checked":""} data-id="${task.id}" class="doneBox"/></td>
      <td>${task.name}</td>
      <td>${task.type}</td>
      <td>${task.points}</td>
      <td><input type="text" value="${rec.note||""}" data-id="${task.id}" class="noteInp"/></td>
      <td><button class="btn secondary" data-id="${task.id}" data-act="del">删除</button></td>
    `;
    tb.appendChild(tr);
  });
  $("#todayDate").textContent = todayStr();
  recomputeToday();
}
function recomputeToday(){
  const date = todayStr();
  ensureRecord(date);
  let total = 0;
  state.tasks.forEach(t=>{
    const rec = state.records[date].items[t.id];
    if(rec && rec.done){ total += t.points; }
  });
  const cap = Number(state.settings.maxDailyPoints||30);
  if(total>cap) total = cap;
  state.records[date].total = total;
  $("#todayTotal").textContent = total;
  $("#todayInfo").textContent = `每日积分上限：${cap} 分`;
  // today log
  const tb = $("#todayLog tbody");
  tb.innerHTML="";
  state.tasks.forEach(t=>{
    const rec = state.records[date].items[t.id] || {done:false, note:""};
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${t.name}</td><td>${t.type}</td><td>${t.points}</td><td>${rec.done?"✔":""}</td><td>${rec.note||""}</td>`;
    tb.appendChild(tr);
  });
  // week total
  $("#weekTotal").textContent = weekTotal(new Date());
  $("#availablePoints").textContent = availablePoints();
}
function weekTotal(d){
  const start = new Date(weekStartStr(d));
  let sum = 0;
  for(let i=0;i<7;i++){
    const dt = new Date(start); dt.setDate(start.getDate()+i);
    const key = dt.toISOString().slice(0,10);
    if(state.records[key]) sum += (state.records[key].total||0);
  }
  return sum;
}
function availablePoints(){
  let earned = 0;
  Object.values(state.records).forEach(r=>earned+= (r.total||0));
  let spent = 0;
  state.redeem.forEach(r=>spent += (r.cost||0));
  return Math.max(0, earned - spent);
}
document.addEventListener("change",(e)=>{
  if(e.target.classList.contains("doneBox")){
    const id = Number(e.target.dataset.id);
    const date = todayStr();
    ensureRecord(date);
    state.records[date].items[id] = state.records[date].items[id] || {done:false, note:""};
    state.records[date].items[id].done = e.target.checked;
    recomputeToday();
  }
  if(e.target.classList.contains("noteInp")){
    const id = Number(e.target.dataset.id);
    const date = todayStr();
    ensureRecord(date);
    state.records[date].items[id] = state.records[date].items[id] || {done:false, note:""};
    state.records[date].items[id].note = e.target.value;
  }
});
$("#addTaskBtn").onclick = ()=>{
  const name = $("#newTaskName").value.trim();
  const pts = Number($("#newTaskPoints").value);
  const type = $("#newTaskType").value;
  if(!name || !pts){ alert("请填写任务名称与积分"); return; }
  const id = (state.tasks.reduce((m,t)=>Math.max(m,t.id),0) || 0) + 1;
  state.tasks.push({id,name,points:pts,type});
  $("#newTaskName").value=""; $("#newTaskPoints").value="";
  renderTaskTable(); saveState(state);
};
$("#taskTable").addEventListener("click",(e)=>{
  if(e.target.dataset.act==="del"){
    const id = Number(e.target.dataset.id);
    state.tasks = state.tasks.filter(t=>t.id!==id);
    Object.values(state.records).forEach(r=>{
      if(r.items[id]) delete r.items[id];
    });
    renderTaskTable(); saveState(state);
  }
});
$("#saveTodayBtn").onclick = ()=>{ saveState(state); $("#todayInfo").textContent = "今日记录已保存"; setTimeout(()=>$("#todayInfo").textContent="",1500); };

// ------- Rewards -> Coupons -------
function renderRewards(){
  const tb = $("#rewardTable tbody"); tb.innerHTML="";
  state.rewards.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.type}</td><td>${r.name}${r.coupon?'（时间券）':''}</td><td>${r.cost}</td><td><button class="btn secondary" data-id="${r.id}" data-act="del-reward">删除</button></td>`;
    tb.appendChild(tr);
  });
  const sel = $("#rewardSelect"); sel.innerHTML="";
  state.rewards.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id; opt.textContent = `[${r.type}] ${r.name}（${r.cost} 分）`;
    sel.appendChild(opt);
  });
  $("#availablePoints").textContent = availablePoints();
  $("#redeemCount").textContent = redeemCountThisWeek();
}
function redeemCountThisWeek(){
  const ws = weekStartStr();
  return state.redeem.filter(r=>r.weekStart===ws).length;
}
$("#addRewardBtn").onclick = ()=>{
  const name = $("#rewardName").value.trim();
  const cost = Number($("#rewardCost").value);
  const type = $("#rewardType").value;
  if(!name || !cost){ alert("请填写奖励名称与所需积分"); return; }
  const id = (state.rewards.reduce((m,t)=>Math.max(m,t.id),0) || 0) + 1;
  // 默认：名字包含“券”的视为时间券
  const coupon = /券/.test(name);
  state.rewards.push({id,type,name,cost,coupon});
  $("#rewardName").value=""; $("#rewardCost").value="";
  renderRewards(); saveState(state);
};
$("#rewardTable").addEventListener("click",(e)=>{
  if(e.target.dataset.act==="del-reward"){
    const id = Number(e.target.dataset.id);
    state.rewards = state.rewards.filter(r=>r.id!==id);
    renderRewards(); saveState(state);
  }
});
$("#redeemBtn").onclick = ()=>{
  const rid = Number($("#rewardSelect").value);
  const r = state.rewards.find(x=>x.id===rid);
  if(!r) return;
  const avail = availablePoints();
  if(avail < r.cost){ alert("积分不足"); return; }
  const limit = Number(state.settings.maxWeeklyRedeem||2);
  if(redeemCountThisWeek() >= limit){ alert("本周兑换次数已达上限"); return; }
  // 基础任务完成检查
  const date = todayStr();
  const baseUnfinished = state.tasks.filter(t=>t.type==="基础任务").some(t=>{
    const it = (state.records[date]||{items:{}}).items[t.id];
    return !(it && it.done);
  });
  if(baseUnfinished && !confirm("检测到今日可能仍有基础任务未全部完成，仍要兑换吗？")) return;

  state.redeem.push({ts: new Date().toISOString(), weekStart: weekStartStr(), name:r.name, cost:r.cost});
  if(r.coupon){
    if(!state.coupons[r.name]) state.coupons[r.name] = {count:0};
    state.coupons[r.name].count += 1;
    alert(`已兑换为时间券：${r.name}（库存 +1）`);
  }else{
    alert(`已兑换非券类奖励：${r.name}（请线下执行）`);
  }
  renderRewards(); renderRedeemLog(); renderCoupons(); saveState(state);
};
function renderRedeemLog(){
  const tb = $("#redeemLog tbody"); tb.innerHTML="";
  state.redeem.slice().reverse().forEach(row=>{
    const tr = document.createElement("tr");
    const dt = new Date(row.ts);
    tr.innerHTML = `<td>${dt.toLocaleString()}</td><td>${row.name}</td><td>${row.cost}</td><td></td>`;
    tb.appendChild(tr);
  });
}

// ------- Coupons page -------
function renderCoupons(){
  // ensure default coupon types exist
  ["15 分钟游戏券", "30 分钟游戏券", "45 分钟游戏券（周末）"].forEach(n=>{
    if(!state.coupons[n]) state.coupons[n] = {count:0};
  });
  const tb = $("#couponTable tbody"); tb.innerHTML="";
  Object.keys(state.coupons).forEach(name=>{
    const tr = document.createElement("tr");
    const count = state.coupons[name].count||0;
    tr.innerHTML = `<td>${name}</td><td>${count}</td>
      <td class="right">
        <button class="btn secondary" data-name="${name}" data-act="add1">+1</button>
        <button class="btn secondary" data-name="${name}" data-act="sub1">-1</button>
        <button class="btn secondary danger" data-name="${name}" data-act="delType">删除券种</button>
      </td>`;
    tb.appendChild(tr);
  });
  // usage select
  const sel = $("#couponSelect"); sel.innerHTML="";
  Object.keys(state.coupons).forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = `${name}（库存 ${state.coupons[name].count||0}）`;
    sel.appendChild(opt);
  });
  $("#todayCouponUsed").textContent = couponsUsedToday();
  $("#dailyCouponLimit").textContent = state.settings.maxDailyCoupons || 1;
}
function couponsUsedToday(){
  const t = todayStr();
  return state.couponLogs.filter(x=>x.ts.slice(0,10)===t).length;
}
document.getElementById("couponTable").addEventListener("click",(e)=>{
  const act = e.target.dataset.act;
  const name = e.target.dataset.name;
  if(!act || !name) return;
  if(act==="add1"){ state.coupons[name].count = (state.coupons[name].count||0)+1; }
  if(act==="sub1"){ state.coupons[name].count = Math.max(0,(state.coupons[name].count||0)-1); }
  if(act==="delType"){ if(confirm("确定删除该券种？")) delete state.coupons[name]; }
  renderCoupons(); saveState(state);
});
document.getElementById("addCouponType").onclick = ()=>{
  const n = $("#newCouponName").value.trim();
  if(!n){ alert("请输入券名"); return; }
  if(!state.coupons[n]) state.coupons[n] = {count:0};
  $("#newCouponName").value="";
  renderCoupons(); saveState(state);
};
document.getElementById("useCouponBtn").onclick = ()=>{
  const name = $("#couponSelect").value;
  if(!name) return;
  const limit = Number(state.settings.maxDailyCoupons||1);
  if(couponsUsedToday() >= limit){ alert("今日使用次数已达上限"); return; }
  if((state.coupons[name]?.count||0) <= 0){ alert("库存不足"); return; }
  state.coupons[name].count -= 1;
  state.couponLogs.push({ts:new Date().toISOString(), name});
  renderCoupons(); renderCouponLog(); saveState(state);
};
function renderCouponLog(){
  const tb = $("#couponLog tbody"); tb.innerHTML="";
  state.couponLogs.slice().reverse().forEach(row=>{
    const tr = document.createElement("tr");
    const dt = new Date(row.ts);
    tr.innerHTML = `<td>${dt.toLocaleString()}</td><td>${row.name}</td><td></td>`;
    tb.appendChild(tr);
  });
}

// ------- Levels -------
function renderLevels(){
  const tb = $("#levelTable tbody"); tb.innerHTML="";
  state.levels.forEach(l=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${l.level}</td><td>${l.cond}</td><td>${l.perk}</td>`;
    tb.appendChild(tr);
  });
}
function computeLevel(){
  const weeks = [];
  for(let i=0;i<12;i++){
    const d = new Date(); d.setDate(d.getDate()-7*i);
    const start = new Date(weekStartStr(d));
    const key = start.toISOString().slice(0,10);
    let sum = 0;
    for(let j=0;j<7;j++){
      const day = new Date(start); day.setDate(start.getDate()+j);
      const kd = day.toISOString().slice(0,10);
      if(state.records[kd]) sum += (state.records[kd].total||0);
    }
    weeks.push({key, sum, avg: Math.round(sum/7)});
  }
  let level = "LV.1 初学者";
  const recent = weeks[0]?.avg||0;
  const last2 = weeks.slice(0,2).every(w=>w.avg>=85);
  const last4NoZero = weeks.slice(0,4).every(w=>w.sum>0);
  const totalAll = Object.values(state.records).reduce((a,b)=>a+(b.total||0),0);
  if(last2) level = "LV.2 能干者";
  if(last4NoZero && totalAll>=350) level = "LV.3 小达人";
  $("#currentLevel").textContent = `当前等级：${level}（本周均分 ${recent}）`;
}

// ------- Weekly Review -------
$("#saveReviewBtn").onclick = ()=>{
  const ws = weekStartStr();
  state.reviews[ws] = { r1: $("#r1").value, r2: $("#r2").value, r3: $("#r3").value, r4: $("#r4").value, r5: $("#r5").value };
  saveState(state);
  $("#reviewInfo").textContent = "已保存"; setTimeout(()=>$("#reviewInfo").textContent="",1500);
  renderReviewTable();
};
$("#exportReviewBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state.reviews,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "weekly_reviews.json"; a.click();
  URL.revokeObjectURL(url);
};
function renderReviewTable(){
  const tb = $("#reviewTable tbody"); tb.innerHTML="";
  Object.entries(state.reviews).sort((a,b)=>a[0]<b[0]?1:-1).forEach(([ws, r])=>{
    const tr = document.createElement("tr");
    const summary = (r.r1||"").slice(0,30);
    tr.innerHTML = `<td>${ws}</td><td>${summary}</td>`;
    tb.appendChild(tr);
  });
}

// ------- Settings / I/O -------
$("#saveSettingsBtn").onclick = ()=>{
  state.settings.maxWeeklyRedeem = Number($("#maxWeeklyRedeem").value||2);
  state.settings.maxDailyPoints = Number($("#maxDailyPoints").value||30);
  state.settings.maxDailyCoupons = Number($("#maxDailyCoupons").value||1);
  saveState(state);
  $("#settingsInfo").textContent = "设置已保存"; setTimeout(()=>$("#settingsInfo").textContent="",1500);
  recomputeToday(); renderRewards(); renderCoupons();
};
$("#exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "family_reward_backup.json"; a.click();
  URL.revokeObjectURL(url);
};
$("#importBtn").onclick = ()=>{
  const f = $("#importFile").files[0];
  if(!f){ alert("请选择JSON文件"); return; }
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      state = Object.assign({}, defaultState, obj);
      saveState(state);
      init();
      alert("导入成功");
    }catch(e){ alert("导入失败："+e.message); }
  };
  reader.readAsText(f);
};
$("#resetBtn").onclick = ()=>{
  if(confirm("确定清空所有数据？此操作不可撤销")){ localStorage.removeItem("family_reward_state_pwa_v1"); state = JSON.parse(JSON.stringify(defaultState)); init(); }
};

// ------- Init -------
function init(){
  renderTabs();
  renderTaskTable();
  renderRewards();
  renderRedeemLog();
  renderCoupons();
  renderLevels();
  renderReviewTable();
  $("#maxWeeklyRedeem").value = state.settings.maxWeeklyRedeem;
  $("#maxDailyPoints").value = state.settings.maxDailyPoints;
  $("#maxDailyCoupons").value = state.settings.maxDailyCoupons;
}
init();
</script>
</body>
</html>
